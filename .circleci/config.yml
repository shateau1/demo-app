version: 2.1
orbs:
  heroku: circleci/heroku@2.0.0

workflows:
  build_tests:
    jobs:
      - run_tests
      - build-docker_image
          # image: $DOCKER_LOGIN/$CIRCLE_PROJECT_REPONAME
          # tag: $CIRCLE_BRANCH.$CIRCLE_SHA1

jobs:
  run_tests:
    docker:
      - image: cimg/node:18.10.0
    steps:
      - checkout
      - run:
          name: Install npm dependencies
          command: |
            npm install --save
      # - run:
      #     name: Run Unit tests
      #     command: |
      #       npx mocha tests/ --reporter mochawesome --reporter-options reportDir=tets-results,reportFileName=tets-results
      # - store_test_results:
      #     path: tets-results
      # - store_artifacts:
      #     path: tets-results

  build-docker_image:
    docker:
      - image: cimg/node:18.10.0
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - heroku/install
      - heroku/check-authentication
      - setup_remote_docker:
          version: 20.10.14
      - heroku/push-docker-image:
          app-name: $HEROKU_APP_NAME
          process-types: web
